import { firebaseConfig } from '../config';

export function generateCoreJs({ siteId }) {
  const cfg = JSON.stringify(firebaseConfig);
  const content = `(()=>{const SITE_ID=${JSON.stringify(siteId)};const CONFIG=${cfg};const load=(src)=>new Promise((res,rej)=>{const s=document.createElement('script');s.src=src;s.async=true;s.onload=()=>res();s.onerror=()=>rej(new Error('load_fail:'+src));document.head.appendChild(s);});const postAll=(msg)=>{try{if(window.parent){window.parent.postMessage(msg,'*');}if(window.opener){window.opener.postMessage(msg,'*');}}catch(_){return null}};const safeSelect=(sel)=>{try{return document.querySelector(sel)||null;}catch(_){return null}};const applyCmd=(cmd)=>{try{if(!cmd||!cmd.type)return;switch(cmd.type){case 'PING':postAll({type:'PONG',siteId:SITE_ID});break;case 'SET_TEXT':{const el=safeSelect(cmd.selector);if(el){el.textContent=String(cmd.text||'');postAll({type:'ACK',siteId:SITE_ID,cmd:'SET_TEXT'})}break}case 'INJECT_HTML':{const el=safeSelect(cmd.selector);if(el){el.innerHTML=String(cmd.html||'');postAll({type:'ACK',siteId:SITE_ID,cmd:'INJECT_HTML'})}break}case 'ADD_CLASS':{const el=safeSelect(cmd.selector);if(el){el.classList.add(String(cmd.className||''));postAll({type:'ACK',siteId:SITE_ID,cmd:'ADD_CLASS'})}break}case 'REMOVE_CLASS':{const el=safeSelect(cmd.selector);if(el){el.classList.remove(String(cmd.className||''));postAll({type:'ACK',siteId:SITE_ID,cmd:'REMOVE_CLASS'})}break}default:postAll({type:'ERROR',siteId:SITE_ID,error:'unknown_cmd'})}}catch(_){postAll({type:'ERROR',siteId:SITE_ID,error:'cmd_exception'})}};window.addEventListener('message',(ev)=>{const data=ev&&ev.data;if(!data)return;if(data&&data.type==='PANEL_TO_CORE'&&data.siteId===SITE_ID){applyCmd(data.command)}});postAll({type:'PANEL_CORE_HANDSHAKE',siteId:SITE_ID,domain:location.hostname});const FRAME_ID='__panel_maintenance_frame';const showOverlay=(txt)=>{let f=document.getElementById(FRAME_ID);if(!f){f=document.createElement('iframe');f.id=FRAME_ID;f.setAttribute('aria-hidden','true');f.style.position='fixed';f.style.inset='0';f.style.width='100%';f.style.height='100%';f.style.border='0';f.style.zIndex='2147483647';f.style.pointerEvents='all';f.srcdoc='<!doctype html><html><head><meta name="viewport" content="width=device-width,initial-scale=1"><style>html,body{height:100%;margin:0}body{display:flex;align-items:center;justify-content:center;background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;text-align:center}h1{margin:0 0 1rem;font-size:2rem}p{margin:0;font-size:1rem;opacity:.9}</style></head><body><div><h1>Sitio en mantenimiento</h1><p>'+String(txt||'Estamos realizando mejoras. Vuelve m√°s tarde.')+'</p></div></body></html>';document.body.appendChild(f);}else{f.style.display='block'}};const hideOverlay=()=>{const f=document.getElementById(FRAME_ID);if(f){f.style.display='none'}};(async()=>{try{await load('https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js');await load('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js');if(!window.firebase||!window.firebase.initializeApp)throw new Error('firebase_unavailable');window.firebase.initializeApp(CONFIG);const db=window.firebase.firestore();window.firebase.firestore&&window.firebase.firestore().enableIndexedDbPersistence&&window.firebase.firestore().enableIndexedDbPersistence().catch(function(){return null});db.collection('publicSites').doc(SITE_ID).onSnapshot((snap)=>{const d=snap&&snap.data?snap.data():null;const status=d&&d.status?String(d.status):'online';if(status==='maintenance'){showOverlay(d&&d.message?d.message:null)}else{hideOverlay()}});}catch(_){postAll({type:'ERROR',siteId:SITE_ID,error:'core_init_failed'})}})();})();`;
  return content;
}
