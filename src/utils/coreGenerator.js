import { firebaseConfig } from '../config';

export function generateCoreJs({ siteId }) {
  const cfg = JSON.stringify(firebaseConfig);
  const content = `(()=>{const SITE_ID=${JSON.stringify(siteId)};const CONFIG=${cfg};const load=(src)=>new Promise((res,rej)=>{const s=document.createElement('script');s.src=src;s.onload=()=>res();s.onerror=()=>rej(new Error('load_fail:'+src));document.head.appendChild(s);});const postAll=(msg)=>{try{if(window.parent){window.parent.postMessage(msg,'*');}if(window.opener){window.opener.postMessage(msg,'*');}}catch(e){}};const safeSelect=(sel)=>{try{return document.querySelector(sel)||null;}catch(e){return null}};const applyCmd=(cmd)=>{try{if(!cmd||!cmd.type)return;switch(cmd.type){case 'PING':postAll({type:'PONG',siteId:SITE_ID});break;case 'SET_TEXT':{const el=safeSelect(cmd.selector);if(el){el.textContent=String(cmd.text||'');postAll({type:'ACK',siteId:SITE_ID,cmd:'SET_TEXT'})}break}case 'INJECT_HTML':{const el=safeSelect(cmd.selector);if(el){el.innerHTML=String(cmd.html||'');postAll({type:'ACK',siteId:SITE_ID,cmd:'INJECT_HTML'})}break}case 'ADD_CLASS':{const el=safeSelect(cmd.selector);if(el){el.classList.add(String(cmd.className||''));postAll({type:'ACK',siteId:SITE_ID,cmd:'ADD_CLASS'})}break}case 'REMOVE_CLASS':{const el=safeSelect(cmd.selector);if(el){el.classList.remove(String(cmd.className||''));postAll({type:'ACK',siteId:SITE_ID,cmd:'REMOVE_CLASS'})}break}default:postAll({type:'ERROR',siteId:SITE_ID,error:'unknown_cmd'})}}catch(e){postAll({type:'ERROR',siteId:SITE_ID,error:'cmd_exception'})}};window.addEventListener('message',(ev)=>{const data=ev&&ev.data;if(!data)return;if(data&&data.type==='PANEL_TO_CORE'&&data.siteId===SITE_ID){applyCmd(data.command)}});postAll({type:'PANEL_CORE_HANDSHAKE',siteId:SITE_ID,domain:location.hostname});})();`;
  return content;
}
